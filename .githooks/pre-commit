#!/bin/zsh

# GoProX Pre-commit Hook
# Runs comprehensive checks before allowing commits

echo "üîç Running pre-commit checks..."

# Check for TODO/FIXME comments in staged files
if git diff --cached --name-only | xargs grep -l "TODO\|FIXME" 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: Found TODO/FIXME comments in staged files"
    echo "   Consider addressing these before committing"
fi

# Check for large files (>10MB)
large_files=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 10485760 {print $9}')
if [[ -n "$large_files" ]]; then
    echo "‚ö†Ô∏è  Warning: Found files larger than 10MB"
    echo "   Consider using Git LFS for large files"
fi

# YAML Linting (if yamllint is available)
if command -v yamllint &> /dev/null; then
    echo "üîç Running YAML linting..."
    
    # Get staged YAML files
    yaml_files=$(git diff --cached --name-only | grep -E '\.(yml|yaml)$' || true)
    
    if [[ -n "$yaml_files" ]]; then
        for file in $yaml_files; do
            if [[ -f "$file" ]]; then
                if ! yamllint -c .yamllint "$file" 2>/dev/null; then
                    echo "‚ùå YAML linting failed for $file"
                    echo "   Run: ./scripts/maintenance/fix-yaml-formatting.zsh to auto-fix"
                    exit 1
                fi
            fi
        done
        echo "‚úÖ YAML linting passed"
    else
        echo "‚ÑπÔ∏è  No YAML files staged for linting"
    fi
else
    echo "‚ÑπÔ∏è  yamllint not available - skipping YAML linting"
    echo "   Install with: brew install yamllint or pip3 install yamllint"
fi

# Check for logger usage in zsh scripts (per design principles)
echo "üîç Checking logger usage in zsh scripts..."
zsh_files=$(git diff --cached --name-only | grep -E '\.zsh$' || true)
if [[ -n "$zsh_files" ]]; then
    for file in $zsh_files; do
        if [[ -f "$file" ]]; then
            # Skip if it's a core module (they define the logger)
            if [[ "$file" != *"/core/"* ]]; then
                if ! grep -q "log_" "$file"; then
                    echo "‚ö†Ô∏è  Warning: $file doesn't use logger functions"
                    echo "   Consider using log_info, log_error, etc. for consistent logging"
                fi
            fi
        fi
    done
fi

# JSON Linting (if jsonlint is available)
if command -v jsonlint &> /dev/null; then
    echo "üîç Running JSON linting..."
    
    # Get staged JSON files
    json_files=$(git diff --cached --name-only | grep -E '\.json$' || true)
    
    if [[ -n "$json_files" ]]; then
        for file in $json_files; do
            if [[ -f "$file" ]]; then
                if ! jsonlint "$file" >/dev/null 2>&1; then
                    echo "‚ùå JSON linting failed for $file"
                    echo "   Run: jsonlint $file to see errors"
                    exit 1
                fi
            fi
        done
        echo "‚úÖ JSON linting passed"
    else
        echo "‚ÑπÔ∏è  No JSON files staged for linting"
    fi
else
    echo "‚ÑπÔ∏è  jsonlint not available - skipping JSON linting"
    echo "   Install with: npm install -g jsonlint"
fi

# Check for file headers (copyright, license, usage patterns)
echo "üîç Checking file headers..."
staged_files=$(git diff --cached --name-only || true)
if [[ -n "$staged_files" ]]; then
    for file in $staged_files; do
        if [[ -f "$file" ]]; then
            # Check for copyright notices in source files
            if [[ "$file" =~ \.(zsh|md|yaml|yml|json)$ ]]; then
                if ! head -10 "$file" | grep -q "Copyright\|copyright"; then
                    echo "‚ö†Ô∏è  Warning: $file missing copyright notice"
                    echo "   Consider adding copyright header to file"
                fi
            fi
            
            # Check for license headers in appropriate files
            if [[ "$file" =~ \.(zsh|md)$ ]]; then
                if ! head -10 "$file" | grep -q "License\|license"; then
                    echo "‚ö†Ô∏è  Warning: $file missing license header"
                    echo "   Consider adding license information to file"
                fi
            fi
            
            # Check for usage patterns in documentation
            if [[ "$file" =~ \.md$ ]] && [[ "$file" != README.md ]] && [[ "$file" != CONTRIBUTING.md ]]; then
                if ! head -10 "$file" | grep -q "Usage\|usage"; then
                    echo "‚ö†Ô∏è  Warning: $file missing usage documentation"
                    echo "   Consider adding usage examples to documentation"
                fi
            fi
        fi
    done
fi

echo "‚úÖ Pre-commit checks completed"
exit 0
